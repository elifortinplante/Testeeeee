<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Flashcards</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; background: linear-gradient(135deg,#a18cd1,#fbc2eb,#8fd3f4); min-height:100vh; display:flex; justify-content:center; align-items:center; }
  .container { width:90%; max-width:800px; background:white; border-radius:20px; padding:20px; box-shadow:0 8px 20px rgba(0,0,0,0.2);}
  h1,h2{text-align:center;color:#333;}
  .hidden{display:none;}
  .set{display:flex;align-items:center;background:#f3f3f3;border-radius:15px;padding:10px;margin:10px 0;cursor:pointer;transition:0.3s;}
  .set:hover{background:#e8e8e8;}
  .set img{width:60px;height:60px;border-radius:12px;object-fit:cover;margin-right:15px;}
  .set-buttons{margin-left:auto;display:flex;gap:5px;}
  .card-container{perspective:1000px;margin:20px 0;}
  .card{width:100%;height:350px;position:relative;transform-style:preserve-3d;transition:transform 0.6s;cursor:pointer;}
  .card.flipped{transform:rotateY(180deg);}
  .card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:20px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px;box-sizing:border-box;font-weight:bold;text-align:center;color:#333;overflow:hidden;}
  .card-front{background:#fff;}
  .card-back{background:#f0f0f0;transform:rotateY(180deg);}
  .card-face img{width:100%;max-height:250px;margin-bottom:15px;object-fit:contain;}
  .answer-buttons{display:flex;justify-content:space-between;margin-top:20px;}
  .answer-buttons button{flex:1;margin:0 5px;padding:10px;font-size:18px;border:none;border-radius:12px;cursor:pointer;transition:0.3s;}
  .correct{background:#a0e7a0;}
  .incorrect{background:#f28b82;}
  .correct:hover{background:#77d677;}
  .incorrect:hover{background:#e06666;}
  #score-screen{text-align:center;}
  #score-screen button{margin:10px;padding:12px 20px;font-size:16px;border:none;border-radius:12px;cursor:pointer;background:#a18cd1;color:white;transition:0.3s;}
  #score-screen button:hover{background:#875fb3;}
  .card-editor{margin-bottom:10px;}
  .card-editor input{display:block;width:95%;margin-bottom:5px;}
</style>
</head>
<body>
<div class="container">

<!-- Accueil -->
<div id="home-screen">
  <h1>Mes Sets</h1>
  <button id="new-set-btn">‚ûï Nouveau set</button>
  <button id="import-set-btn">üì• Importer un set</button>
  <input type="file" id="import-file" class="hidden">
  <div id="sets-list"></div>
</div>

<!-- √âdition -->
<div id="editor-screen" class="hidden">
  <h2>Cr√©er / Modifier un Set</h2>
  <input type="text" id="set-title" placeholder="Titre du set"><br><br>
  <input type="text" id="set-subject" placeholder="Mati√®re"><br><br>
  <input type="text" id="set-image" placeholder="URL image pour l‚Äôaccueil">
  <input type="file" accept="image/*" id="set-image-file" style="display:none">
  <button id="choose-cover-btn">üì∏ Galerie couverture</button><br><br>
  <div id="cards-editor"></div>
  <button id="add-card-btn">‚ûï Ajouter une carte</button><br><br>
  <button id="save-set-btn">üíæ Sauvegarder</button>
  <button id="home-btn-editor">üè† Accueil</button>
</div>

<!-- Jeu -->
<div id="game-screen" class="hidden">
  <h2 id="game-title"></h2>
  <div class="card-container">
    <div class="card" id="current-card">
      <div class="card-face card-front">
        <img id="card-image-front" alt="">
        <div id="card-question"></div>
      </div>
      <div class="card-face card-back">
        <img id="card-image-back" alt="">
        <div id="card-answer"></div>
      </div>
    </div>
  </div>
  <div class="answer-buttons">
    <button id="bad-btn" class="incorrect">Mauvais</button>
    <button id="good-btn" class="correct">Bon</button>
  </div>
</div>

<!-- Score -->
<div id="score-screen" class="hidden">
  <h2>R√©sultat</h2>
  <p id="final-score"></p>
  <button id="restart-all-btn">üîÑ Recommencer tout</button>
  <button id="restart-errors-btn">‚ùå Rejouer erreurs</button>
  <button id="home-btn-score">üè† Accueil</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBj2oSXyXuiXsxbIVYRZLSqE0OczPjgk6I",
  authDomain: "mesflashcards.firebaseapp.com",
  projectId: "mesflashcards",
  storageBucket: "mesflashcards.appspot.com",
  messagingSenderId: "307428456397",
  appId: "1:307428456397:web:122607a9c47b02f5633684"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ==== Variables ====
let sets = [];
let currentSet = null;
let currentCards = [];
let currentIndex = 0;
let errors = [];

// ==== Fonctions ====
async function loadSets() {
  try {
    const docSnap = await getDoc(doc(db, "flashcards", "mysets"));
    sets = docSnap.exists() ? docSnap.data().sets : [];
  } catch(e){console.log(e); sets=[];}
  displaySets();
}

async function saveSetsToFirebase() {
  try{ await setDoc(doc(db,"flashcards","mysets"),{sets}); } catch(e){console.log(e);}
}

function hideAllScreens() {
  document.querySelectorAll(".container > div").forEach(d=>d.classList.add("hidden"));
}

function goHome() { hideAllScreens(); document.getElementById("home-screen").classList.remove("hidden"); displaySets(); }

function showSetEditor(setIndex=null){
  hideAllScreens();
  document.getElementById("editor-screen").classList.remove("hidden");
  document.getElementById("cards-editor").innerHTML="";
  document.getElementById("set-image-file").onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => document.getElementById("set-image").value = ev.target.result;
    reader.readAsDataURL(file);
  };
  if(setIndex!==null){
    currentSet = sets[setIndex];
    document.getElementById("set-title").value = currentSet.title;
    document.getElementById("set-subject").value = currentSet.subject;
    document.getElementById("set-image").value = currentSet.image||"";
    currentSet.cards.forEach(c=>addCardEditor(c.question,c.answer,c.image));
  } else { currentSet=null; }
}

function addCardEditor(q='',a='',img=''){
  const div=document.createElement("div");
  div.className="card-editor";
  div.innerHTML=`<input type="text" placeholder="Question" value="${q}">
                 <input type="text" placeholder="R√©ponse" value="${a}">
                 <input type="text" placeholder="URL image ou vide" value="${img}">
                 <input type="file" accept="image/*" class="img-upload" style="display:none">
                 <button class="btn-photo">üì∏ Galerie</button>
                 <button class="btn-del-card">üóëÔ∏è Supprimer cette carte</button>
                 <hr>`;
  document.getElementById("cards-editor").appendChild(div);
  const imgInput = div.querySelector(".img-upload");
  const urlInput = div.children[2];
  div.querySelector(".btn-photo").addEventListener("click", ()=>imgInput.click());
  imgInput.addEventListener("change", e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload = ev => urlInput.value = ev.target.result;
    reader.readAsDataURL(file);
  });
  div.querySelector(".btn-del-card").addEventListener("click", ()=>div.remove());
}

async function saveSet(){
  const title=document.getElementById("set-title").value;
  const subject=document.getElementById("set-subject").value;
  const image=document.getElementById("set-image").value;
  const cards=[];
  document.querySelectorAll("#cards-editor>.card-editor").forEach(div=>{
    const q=div.children[0].value, a=div.children[1].value, img=div.children[2].value;
    if(q&&a) cards.push({question:q,answer:a,image:img});
  });
  if(currentSet){ currentSet.title=title; currentSet.subject=subject; currentSet.image=image; currentSet.cards=cards; }
  else sets.push({title,subject,image,cards});
  await saveSetsToFirebase(); currentSet=null; goHome();
}

function displaySets(){
  const list=document.getElementById("sets-list"); list.innerHTML="";
  sets.forEach((s,i)=>{
    const div=document.createElement("div"); div.className="set";
    div.innerHTML=`<img src="${s.image||'https://via.placeholder.com/60'}"><div><strong>${s.title}</strong><br><small>${s.subject}</small></div>`;
    div.addEventListener("click", ()=>startGame(i));

    const buttonsDiv=document.createElement("div"); buttonsDiv.className="set-buttons";
    const editBtn=document.createElement("button"); editBtn.textContent="‚úèÔ∏è Modifier";
    editBtn.addEventListener("click", e=>{ e.stopPropagation(); showSetEditor(i);});
    const delBtn=document.createElement("button"); delBtn.textContent="üóëÔ∏è Supprimer";
    delBtn.addEventListener("click", e=>{ e.stopPropagation(); sets.splice(i,1); saveSetsToFirebase(); displaySets(); });
    buttonsDiv.appendChild(editBtn); buttonsDiv.appendChild(delBtn); div.appendChild(buttonsDiv);
    list.appendChild(div);
  });
}

// ===== Jeu =====
function startGame(i){ currentSet=sets[i]; currentCards=[...currentSet.cards]; currentIndex=0; errors=[]; hideAllScreens(); document.getElementById("game-screen").classList.remove("hidden"); document.getElementById("game-title").textContent=currentSet.title; showCard(); }
function showCard(){ const card=currentCards[currentIndex]; document.getElementById("card-question").textContent=card.question; document.getElementById("card-answer").textContent=card.answer;
if(card.image){ document.getElementById("card-image-front").src=card.image; document.getElementById("card-image-back").src=card.image; document.getElementById("card-image-front").style.display="block"; document.getElementById("card-image-back").style.display="block";} else { document.getElementById("card-image-front").style.display="none"; document.getElementById("card-image-back").style.display="none";}
document.getElementById("current-card").classList.remove("flipped");}
function flipCard(){ document.getElementById("current-card").classList.toggle("flipped"); }
function markAnswer(correct){ if(!correct) errors.push(currentCards[currentIndex]); currentIndex++; if(currentIndex<currentCards.length) showCard(); else endGame(); }
function endGame(){ hideAllScreens(); document.getElementById("score-screen").classList.remove("hidden"); document.getElementById("final-score").textContent=`Score: ${currentCards.length-errors.length}/${currentCards.length}`; }
function restartAll(){ currentCards=[...currentSet.cards]; currentIndex=0; errors=[]; hideAllScreens(); document.getElementById("game-screen").classList.remove("hidden"); showCard(); }
function restartErrors(){ if(errors.length===0){ alert("Aucune erreur √† rejouer !"); return;} currentCards=[...errors]; currentIndex=0; errors=[]; hideAllScreens(); document.getElementById("game-screen").classList.remove("hidden"); showCard(); }

function importSet(event){ const file=event.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=function(e){ try{ const importedSet=JSON.parse(e.target.result); sets.push(importedSet); saveSetsToFirebase(); displaySets(); alert("Set import√© avec succ√®s !"); }catch(err){ alert("Fichier invalide !");} }; reader.readAsText(file); }

// ==== Attacher tous les boutons ====
document.getElementById("new-set-btn").addEventListener("click", ()=>showSetEditor());
document.getElementById("import-set-btn").addEventListener("click", ()=>document.getElementById("import-file").click());
document.getElementById("import-file").addEventListener("change", importSet);
document.getElementById("choose-cover-btn").addEventListener("click", ()=>document.getElementById("set-image-file").click());
document.getElementById("add-card-btn").addEventListener("click", addCardEditor);
document.getElementById("save-set-btn").addEventListener("click", saveSet);
document.getElementById("home-btn-editor").addEventListener("click", goHome);
document.getElementById("good-btn").addEventListener("click", ()=>markAnswer(true));
document.getElementById("bad-btn").addEventListener("click", ()=>markAnswer(false));
document.getElementById("restart-all-btn").addEventListener("click", restartAll);
document.getElementById("restart-errors-btn").addEventListener("click", restartErrors);
document.getElementById("home-btn-score").addEventListener("click", goHome);
document.getElementById("current-card").addEventListener("click", flipCard);

// ==== Charger les sets ====
loadSets();

</script>
</body>
</html>
